<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <!-- Platform-specific variables matching original WiX 3 installer -->
  <?if $(var.Platform)=x64 ?>
    <?define msiUpgradeCode = "A7EAB3EB-6524-4173-B5D8-25FC867BD29E" ?>
    <?define msiProductName = "DirectOutput64" ?>
    <?define msiBitness = "64" ?>
    <?define Win64 = "yes" ?>
    <?define BinDirName = "x64" ?>
    <?define ProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else?>
    <?define msiUpgradeCode = "94E0D0EE-C078-42C6-AD9F-4030B329A040" ?>
    <?define msiProductName = "DirectOutput32" ?>
    <?define msiBitness = "32" ?>
    <?define Win64 = "no" ?>
    <?define BinDirName = "x86" ?>
    <?define ProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif?>

  <Package Name="$(var.msiProductName)" Language="1033" Version="3.2.9407.22473" Manufacturer="DirectOutput" UpgradeCode="$(var.msiUpgradeCode)" InstallerVersion="200" Scope="perUser">
    <SummaryInformation Keywords="Installer" Description="DirectOutput $(var.msiBitness)-bit Framework" Manufacturer="DirectOutput" />
    
    <!-- Retrieve the old install folder from the registry, if set -->
    <Property Id="INSTALLFOLDER" Value="C:\DirectOutput">
      <RegistrySearch Id="InstallFolder" Type="raw" Root="HKCU" Key="SOFTWARE\DirectOutput\DirectOutput" Name="InstallPath" />
    </Property>
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <MediaTemplate EmbedCab="yes" />
    
    <!-- Basic installer properties -->
    <Property Id="ARPPRODUCTICON" Value="DirectOutputIcon" />
    <Icon Id="DirectOutputIcon" SourceFile="DirectOutput\DirectOutputIcon_32.ico" />
    
    <!-- Enable basic Windows Installer UI with directory selection -->
    <Property Id="MSIUSEREALADMINDETECTION" Value="1" />
    <Property Id="ALLUSERS" Value="2" />
    <Property Id="MSIINSTALLPERUSER" Value="1" />
    
    <!-- Enable directory customization via MSI properties -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <!-- Add required WiX variables -->
    <WixVariable Id="WixUICostingPopupOptOut" Value="1" Overridable="yes" />
    <WixVariable Id="WixUILicenseRtf" Value="LICENSE" />
    <WixVariable Id="WixUIBannerBmp" Value="DOFSetup\Res\Banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="DOFSetup\Res\DialogSide.bmp" />
    
    <!-- Custom UI with working folder browse capability -->
    <UI>
      <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
      <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
      <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />
      
      <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
      
      <!-- Reference standard dialogs -->
      <DialogRef Id="BrowseDlg" />
      <DialogRef Id="DiskCostDlg" />
      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <DialogRef Id="PrepareDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ResumeDlg" />
      <DialogRef Id="UserExit" />
      
      <!-- Welcome and Install Directory dialogs -->
      <DialogRef Id="WelcomeDlg" />
      <DialogRef Id="InstallDirDlg" />
      <DialogRef Id="VerifyReadyDlg" />
      
      <!-- Fixed dialog flow that properly updates INSTALLFOLDER -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" />
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2" />
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="1" Condition="NOT Installed" />
      <Publish Dialog="BrowseDlg" Control="OK" Event="SetTargetPath" Value="[_BrowseProperty]" Order="1" />
      <!-- This is the key fix - properly set INSTALLFOLDER when browse dialog closes -->
      <Publish Dialog="BrowseDlg" Control="OK" Event="DoAction" Value="SetInstallFolder" Order="2" />
    </UI>
    
    <!-- Custom action to properly update INSTALLFOLDER from browse selection -->
    <CustomAction Id="SetInstallFolder" Property="INSTALLFOLDER" Value="[_BrowseProperty]" Execute="immediate" />
    
    <Feature Id="ProductFeature" Title="DirectOutput" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>
    
    <!-- Custom Actions for PinballX and B2S Server Integration -->
    <Binary Id="B2SFixupDLL" SourceFile="bin\$(var.Platform)\Release\DOFSetupB2SFixup.CA.dll" />
    <CustomAction Id="B2SFixup" Return="check" Execute="deferred" DllEntry="B2SFixup" Impersonate="yes" BinaryRef="B2SFixupDLL" />
    
    <Binary Id="PBXFixupDLL" SourceFile="bin\$(var.Platform)\Release\DOFSetupPBXFixup.CA.dll" />
    <CustomAction Id="PBXFixup" Return="check" Execute="deferred" DllEntry="PBXFixup" Impersonate="yes" BinaryRef="PBXFixupDLL" />
    
    <!-- Property setters for custom actions -->
    <CustomAction Id="SetB2SVars" Return="check" Property="B2SFixup" Value="INSTALLEDPATH=[INSTALLFOLDER];BINDIR=$(var.BinDirName);BITNESS=$(var.msiBitness)" />
    <CustomAction Id="SetPBXVars" Return="check" Property="PBXFixup" Value="INSTALLEDPATH=[INSTALLFOLDER];BINDIR=$(var.BinDirName);BITNESS=$(var.msiBitness)" />

    <!-- Custom action execution sequence -->
    <InstallExecuteSequence>
      <Custom Action="SetB2SVars" Before="B2SFixup" />
      <Custom Action="B2SFixup" Before="InstallFinalize" Condition="NOT REMOVE=&quot;ALL&quot;" />
      <Custom Action="SetPBXVars" Before="PBXFixup" />
      <Custom Action="PBXFixup" Before="InstallFinalize" Condition="NOT REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>
  </Package>

  <Fragment>
    <!-- Install to user-selected folder with x86/x64 subdirectories for coexistence -->
    <Directory Id="WINDOWSVOLUME">
      <Directory Id="INSTALLFOLDER">
        <!-- Platform-specific subdirectory for executables -->
        <Directory Id="BINDIR" Name="$(var.BinDirName)" />
        <!-- Shared configuration directory -->
        <Directory Id="DOFCONFIGDIR" Name="Config">
          <Directory Id="DOFCONFIGEXAMPLESDIR" Name="Examples" />
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents">
      <!-- Platform-specific executables in subdirectory (x86 or x64) -->
      <Component Id="DirectOutputDll" Directory="BINDIR" Guid="*">
        <File Id="DirectOutputDll" Source="bin\$(var.Platform)\Release\DirectOutput.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="DirectOutputConfig" Directory="BINDIR" Guid="*">
        <File Id="DirectOutputConfig" Source="bin\$(var.Platform)\Release\DirectOutput.dll.config" KeyPath="yes" />
      </Component>
      
      <Component Id="ExtensionsDll" Directory="BINDIR" Guid="*">
        <File Id="ExtensionsDll" Source="bin\$(var.Platform)\Release\Extensions.dll" KeyPath="yes" />
      </Component>
      
      <!-- B2S Server Plugin in platform directory -->
      <Component Id="B2SServerPluginDll" Directory="BINDIR" Guid="*">
        <File Id="B2SServerPluginDll" Source="bin\$(var.Platform)\Release\B2SServerDirectOutputPlugin.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="B2SServerPluginConfig" Directory="BINDIR" Guid="*">
        <File Id="B2SServerPluginConfig" Source="bin\$(var.Platform)\Release\B2SServerDirectOutputPlugin.dll.config" KeyPath="yes" />
      </Component>
      
      <Component Id="B2SServerPluginInterface" Directory="BINDIR" Guid="*">
        <File Id="B2SServerPluginInterface" Source="bin\$(var.Platform)\Release\B2SServerPluginInterface.dll" KeyPath="yes" />
      </Component>
      
      <!-- PinballX Plugin in platform directory -->
      <Component Id="PinballXPluginDll" Directory="BINDIR" Guid="*">
        <File Id="PinballXPluginDll" Source="bin\$(var.Platform)\Release\DirectOutput PinballX Plugin.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="PinballXPluginConfig" Directory="BINDIR" Guid="*">
        <File Id="PinballXPluginConfig" Source="bin\$(var.Platform)\Release\DirectOutput PinballX Plugin.dll.config" KeyPath="yes" />
      </Component>
      
      <!-- COM Object in platform directory -->
      <Component Id="ComObjectDll" Directory="BINDIR" Guid="*">
        <File Id="ComObjectDll" Source="bin\$(var.Platform)\Release\DirectOutputComObject.dll" KeyPath="yes" />
        <RegistryKey Root="HKCR" Key="CLSID\{A23BFDBC-9A8A-46C0-8672-60F23D54FFB6}">
          <RegistryValue Type="string" Value="DirectOutput COM Object" />
          <RegistryKey Key="InprocServer32">
            <RegistryValue Type="string" Value="[#ComObjectDll]" />
            <RegistryValue Name="ThreadingModel" Type="string" Value="Both" />
          </RegistryKey>
        </RegistryKey>
      </Component>
      
      <Component Id="ComObjectConfig" Directory="BINDIR" Guid="*">
        <File Id="ComObjectConfig" Source="bin\$(var.Platform)\Release\DirectOutputComObject.dll.config" KeyPath="yes" />
      </Component>
      
      <Component Id="ComObjectTlb" Directory="BINDIR" Guid="*">
        <File Id="ComObjectTlb" Source="bin\$(var.Platform)\Release\DirectOutputComObject.tlb" KeyPath="yes" />
      </Component>
      
      <!-- Tools in platform directory -->
      <Component Id="ConfigTesterExe" Directory="BINDIR" Guid="*">
        <File Id="ConfigTesterExe" Source="bin\$(var.Platform)\Release\DirectOutputConfigTester.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigTesterConfig" Directory="BINDIR" Guid="*">
        <File Id="ConfigTesterConfig" Source="bin\$(var.Platform)\Release\DirectOutputConfigTester.exe.config" KeyPath="yes" />
      </Component>
      
      <Component Id="GlobalConfigEditorExe" Directory="BINDIR" Guid="*">
        <File Id="GlobalConfigEditorExe" Source="bin\$(var.Platform)\Release\GlobalConfigEditor.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="GlobalConfigEditorConfig" Directory="BINDIR" Guid="*">
        <File Id="GlobalConfigEditorConfig" Source="bin\$(var.Platform)\Release\GlobalConfigEditor.exe.config" KeyPath="yes" />
      </Component>
      
      <Component Id="LedControlFileTesterExe" Directory="BINDIR" Guid="*">
        <File Id="LedControlFileTesterExe" Source="bin\$(var.Platform)\Release\LedControlFileTester.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="LedControlFileTesterConfig" Directory="BINDIR" Guid="*">
        <File Id="LedControlFileTesterConfig" Source="bin\$(var.Platform)\Release\LedControlFileTester.exe.config" KeyPath="yes" />
      </Component>

      <!-- Shared DirectOutput.dll and Extensions.dll in root for backwards compatibility -->
      <Component Id="SharedDirectOutputDll" Directory="INSTALLFOLDER" Guid="*">
        <File Id="SharedDirectOutputDll" Source="bin\$(var.Platform)\Release\DirectOutput.dll" />
      </Component>
      
      <Component Id="SharedExtensionsDll" Directory="INSTALLFOLDER" Guid="*">
        <File Id="SharedExtensionsDll" Source="bin\$(var.Platform)\Release\Extensions.dll" />
      </Component>
      
      <!-- Registry entry to save install path -->
      <Component Id="RegistryEntries" Directory="INSTALLFOLDER" Guid="*">
        <RegistryKey Root="HKCU" Key="SOFTWARE\DirectOutput\DirectOutput">
          <RegistryValue Type="string" Name="InstallPath" Value="[INSTALLFOLDER]" KeyPath="yes" />
        </RegistryKey>
      </Component>
      
      <!-- Dependencies -->
      <Component Id="NewtonsoftJson" Directory="INSTALLFOLDER" Guid="*">
        <File Id="NewtonsoftJson" Source="bin\$(var.Platform)\Release\Newtonsoft.Json.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="CilociFleeLib" Directory="INSTALLFOLDER" Guid="*">
        <File Id="CilociFleeLib" Source="bin\$(var.Platform)\Release\Ciloci.Flee.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="ManagedBass" Directory="INSTALLFOLDER" Guid="*">
        <File Id="ManagedBass" Source="bin\$(var.Platform)\Release\ManagedBass.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="ManagedBassFx" Directory="INSTALLFOLDER" Guid="*">
        <File Id="ManagedBassFx" Source="bin\$(var.Platform)\Release\ManagedBass.Fx.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="ManagedBassMix" Directory="INSTALLFOLDER" Guid="*">
        <File Id="ManagedBassMix" Source="bin\$(var.Platform)\Release\ManagedBass.Mix.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="HueApiLib" Directory="INSTALLFOLDER" Guid="*">
        <File Id="HueApiLib" Source="bin\$(var.Platform)\Release\Q42.HueApi.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="HueApiColorConverters" Directory="INSTALLFOLDER" Guid="*">
        <File Id="HueApiColorConverters" Source="bin\$(var.Platform)\Release\Q42.HueApi.ColorConverters.dll" KeyPath="yes" />
      </Component>
      
      <!-- LedWiz DLL - architecture specific -->
      <?if $(var.Platform)=x64 ?>
      <Component Id="LedWizDll" Directory="INSTALLFOLDER" Guid="*">
        <File Id="LedWizDll" Source="bin\$(var.Platform)\Release\ledwiz64.dll" KeyPath="yes" />
      </Component>
      <?else?>
      <Component Id="LedWizDll" Directory="INSTALLFOLDER" Guid="*">
        <File Id="LedWizDll" Source="DirectOutput\ledwiz32.dll" KeyPath="yes" />
      </Component>
      <?endif?>
      
      <!-- Resources -->
      <Component Id="DirectOutputShapesPng" Directory="INSTALLFOLDER" Guid="*">
        <File Id="DirectOutputShapesPng" Source="bin\$(var.Platform)\Release\DirectOutputShapes.png" KeyPath="yes" />
      </Component>
      
      <Component Id="DirectOutputShapesXml" Directory="INSTALLFOLDER" Guid="*">
        <File Id="DirectOutputShapesXml" Source="bin\$(var.Platform)\Release\DirectOutputShapes.xml" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>