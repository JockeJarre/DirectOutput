<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <!-- Platform-specific variables matching original WiX 3 installer -->
  <?if $(var.Platform)=x64 ?>
    <?define msiUpgradeCode = "A7EAB3EB-6524-4173-B5D8-25FC867BD29E" ?>
    <?define msiProductName = "DirectOutput64" ?>
    <?define msiBitness = "64" ?>
    <?define Win64 = "yes" ?>
    <?define BinDirName = "x64" ?>
    <?define ProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else?>
    <?define msiUpgradeCode = "94E0D0EE-C078-42C6-AD9F-4030B329A040" ?>
    <?define msiProductName = "DirectOutput32" ?>
    <?define msiBitness = "32" ?>
    <?define Win64 = "no" ?>
    <?define BinDirName = "x86" ?>
    <?define ProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif?>

  <Package Name="$(var.msiProductName)" Language="1033" Version="3.2.9407.22473" Manufacturer="DirectOutput" UpgradeCode="$(var.msiUpgradeCode)" InstallerVersion="200" Scope="perUser">
    <SummaryInformation Keywords="Installer" Description="DirectOutput $(var.msiBitness)-bit Framework" Manufacturer="DirectOutput" />
    
    <!-- Retrieve the old install folder from the registry, if set -->
    <Property Id="INSTALLFOLDER">
      <RegistrySearch Id="InstallFolder" Type="raw" Root="HKCU" Key="SOFTWARE\DirectOutput\DirectOutput" Name="InstallPath" />
    </Property>
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <MediaTemplate EmbedCab="yes" />
    
    <!-- Property to track installation directory -->
    <Property Id="WIXUI_INSTALLDIR" Value="DOFDIR" />
    
    <!-- Enable basic MSI UI -->
    <Property Id="MSIUSEREALADMINDETECTION" Value="1" />
    
    <Feature Id="ProductFeature" Title="DirectOutput" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>
    
    <!-- Custom Actions for PinballX and B2S Server Integration -->
    <Binary Id="B2SFixupDLL" SourceFile="DOFSetupB2SFixup\bin\Release\net48\DOFSetupB2SFixup.dll" />
    <CustomAction Id="B2SFixup" Return="check" Execute="deferred" DllEntry="B2SFixup" Impersonate="yes" BinaryRef="B2SFixupDLL" />
    
    <Binary Id="PBXFixupDLL" SourceFile="DOFSetupPBXFixup\bin\Release\net48\DOFSetupPBXFixup.dll" />
    <CustomAction Id="PBXFixup" Return="check" Execute="deferred" DllEntry="PBXFixup" Impersonate="yes" BinaryRef="PBXFixupDLL" />
    
    <!-- Property setters for custom actions -->
    <CustomAction Id="SetB2SVars" Return="check" Property="B2SFixup" Value="INSTALLEDPATH=[DOFDIR];BINDIR=$(var.BinDirName);BITNESS=$(var.msiBitness)" />
    <CustomAction Id="SetPBXVars" Return="check" Property="PBXFixup" Value="INSTALLEDPATH=[DOFDIR];BINDIR=$(var.BinDirName);BITNESS=$(var.msiBitness)" />

    <!-- Set up custom action sequence -->
    <InstallExecuteSequence>
      <Custom Action="SetPBXVars" Before="PBXFixup" />
      <Custom Action="PBXFixup" Before="InstallFinalize" Condition="NOT REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>
  </Package>

  <Fragment>
    <!-- Install to C:\DirectOutput like the original, not Program Files -->
    <!-- Set default install folder to X:\DirectOutput (where X: is the Windows install volume) -->
    <SetDirectory Id="INSTALLFOLDER" Value="[WindowsVolume]DirectOutput" />
    
    <Directory Id="WINDOWSVOLUME">
      <Directory Id="INSTALLFOLDER" Name="DirectOutput">
        <Directory Id="DOFDIR">
          <Directory Id="BINDIR" Name="$(var.BinDirName)" />
          <Directory Id="DOFCONFIGDIR" Name="Config">
            <Directory Id="DOFCONFIGEXAMPLESDIR" Name="Examples" />
          </Directory>
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents">
      <!-- Main DirectOutput files in root directory -->
      <Component Id="DirectOutputDll" Directory="DOFDIR" Guid="*">
        <File Id="DirectOutputDll" Source="bin\$(var.Platform)\Release\DirectOutput.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="DirectOutputConfig" Directory="DOFDIR" Guid="*">
        <File Id="DirectOutputConfig" Source="bin\$(var.Platform)\Release\DirectOutput.dll.config" KeyPath="yes" />
      </Component>
      
      <Component Id="ExtensionsDll" Directory="DOFDIR" Guid="*">
        <File Id="ExtensionsDll" Source="bin\$(var.Platform)\Release\Extensions.dll" KeyPath="yes" />
      </Component>
      
      <!-- Binary files in platform-specific subdirectory -->
      <Component Id="DirectOutputBinDll" Directory="BINDIR" Guid="*">
        <File Id="DirectOutputBinDll" Source="bin\$(var.Platform)\Release\DirectOutput.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="DirectOutputBinConfig" Directory="BINDIR" Guid="*">
        <File Id="DirectOutputBinConfig" Source="bin\$(var.Platform)\Release\DirectOutput.dll.config" KeyPath="yes" />
      </Component>
      
      <Component Id="ExtensionsBinDll" Directory="BINDIR" Guid="*">
        <File Id="ExtensionsBinDll" Source="bin\$(var.Platform)\Release\Extensions.dll" KeyPath="yes" />
      </Component>
      
      <!-- B2S Server Plugin -->
      <Component Id="B2SServerPluginDll" Directory="DOFDIR" Guid="*">
        <File Id="B2SServerPluginDll" Source="bin\$(var.Platform)\Release\B2SServerDirectOutputPlugin.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="B2SServerPluginConfig" Directory="DOFDIR" Guid="*">
        <File Id="B2SServerPluginConfig" Source="bin\$(var.Platform)\Release\B2SServerDirectOutputPlugin.dll.config" KeyPath="yes" />
      </Component>
      
      <Component Id="B2SServerPluginInterface" Directory="DOFDIR" Guid="*">
        <File Id="B2SServerPluginInterface" Source="bin\$(var.Platform)\Release\B2SServerPluginInterface.dll" KeyPath="yes" />
      </Component>
      
      <!-- PinballX Plugin -->
      <Component Id="PinballXPluginDll" Directory="DOFDIR" Guid="*">
        <File Id="PinballXPluginDll" Source="bin\$(var.Platform)\Release\DirectOutput PinballX Plugin.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="PinballXPluginConfig" Directory="DOFDIR" Guid="*">
        <File Id="PinballXPluginConfig" Source="bin\$(var.Platform)\Release\DirectOutput PinballX Plugin.dll.config" KeyPath="yes" />
      </Component>
      
      <!-- COM Object -->
      <Component Id="ComObjectDll" Directory="DOFDIR" Guid="*">
        <File Id="ComObjectDll" Source="bin\$(var.Platform)\Release\DirectOutputComObject.dll" KeyPath="yes" />
        <RegistryKey Root="HKCR" Key="CLSID\{A23BFDBC-9A8A-46C0-8672-60F23D54FFB6}">
          <RegistryValue Type="string" Value="DirectOutput COM Object" />
          <RegistryKey Key="InprocServer32">
            <RegistryValue Type="string" Value="[#ComObjectDll]" />
            <RegistryValue Name="ThreadingModel" Type="string" Value="Both" />
          </RegistryKey>
        </RegistryKey>
      </Component>
      
      <Component Id="ComObjectConfig" Directory="DOFDIR" Guid="*">
        <File Id="ComObjectConfig" Source="bin\$(var.Platform)\Release\DirectOutputComObject.dll.config" KeyPath="yes" />
      </Component>
      
      <Component Id="ComObjectTlb" Directory="DOFDIR" Guid="*">
        <File Id="ComObjectTlb" Source="bin\$(var.Platform)\Release\DirectOutputComObject.tlb" KeyPath="yes" />
      </Component>
      
      <!-- Tools -->
      <Component Id="ConfigTesterExe" Directory="DOFDIR" Guid="*">
        <File Id="ConfigTesterExe" Source="bin\$(var.Platform)\Release\DirectOutputConfigTester.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigTesterConfig" Directory="DOFDIR" Guid="*">
        <File Id="ConfigTesterConfig" Source="bin\$(var.Platform)\Release\DirectOutputConfigTester.exe.config" KeyPath="yes" />
      </Component>
      
      <Component Id="GlobalConfigEditorExe" Directory="DOFDIR" Guid="*">
        <File Id="GlobalConfigEditorExe" Source="bin\$(var.Platform)\Release\GlobalConfigEditor.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="GlobalConfigEditorConfig" Directory="DOFDIR" Guid="*">
        <File Id="GlobalConfigEditorConfig" Source="bin\$(var.Platform)\Release\GlobalConfigEditor.exe.config" KeyPath="yes" />
      </Component>
      
      <Component Id="LedControlFileTesterExe" Directory="DOFDIR" Guid="*">
        <File Id="LedControlFileTesterExe" Source="bin\$(var.Platform)\Release\LedControlFileTester.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="LedControlFileTesterConfig" Directory="DOFDIR" Guid="*">
        <File Id="LedControlFileTesterConfig" Source="bin\$(var.Platform)\Release\LedControlFileTester.exe.config" KeyPath="yes" />
      </Component>
      
      <!-- Registry entry to save install path -->
      <Component Id="RegistryEntries" Directory="DOFDIR" Guid="*">
        <RegistryKey Root="HKCU" Key="SOFTWARE\DirectOutput\DirectOutput">
          <RegistryValue Type="string" Name="InstallPath" Value="[DOFDIR]" KeyPath="yes" />
        </RegistryKey>
      </Component>
      
      <!-- Dependencies -->
      <Component Id="NewtonsoftJson" Directory="DOFDIR" Guid="*">
        <File Id="NewtonsoftJson" Source="bin\$(var.Platform)\Release\Newtonsoft.Json.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="CilociFleeLib" Directory="DOFDIR" Guid="*">
        <File Id="CilociFleeLib" Source="bin\$(var.Platform)\Release\Ciloci.Flee.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="ManagedBass" Directory="DOFDIR" Guid="*">
        <File Id="ManagedBass" Source="bin\$(var.Platform)\Release\ManagedBass.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="ManagedBassFx" Directory="DOFDIR" Guid="*">
        <File Id="ManagedBassFx" Source="bin\$(var.Platform)\Release\ManagedBass.Fx.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="ManagedBassMix" Directory="DOFDIR" Guid="*">
        <File Id="ManagedBassMix" Source="bin\$(var.Platform)\Release\ManagedBass.Mix.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="HueApiLib" Directory="DOFDIR" Guid="*">
        <File Id="HueApiLib" Source="bin\$(var.Platform)\Release\Q42.HueApi.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="HueApiColorConverters" Directory="DOFDIR" Guid="*">
        <File Id="HueApiColorConverters" Source="bin\$(var.Platform)\Release\Q42.HueApi.ColorConverters.dll" KeyPath="yes" />
      </Component>
      
      <!-- LedWiz DLL - architecture specific -->
      <?if $(var.Platform)=x64 ?>
      <Component Id="LedWizDll" Directory="DOFDIR" Guid="*">
        <File Id="LedWizDll" Source="bin\$(var.Platform)\Release\ledwiz64.dll" KeyPath="yes" />
      </Component>
      <?else?>
      <Component Id="LedWizDll" Directory="DOFDIR" Guid="*">
        <File Id="LedWizDll" Source="DirectOutput\ledwiz32.dll" KeyPath="yes" />
      </Component>
      <?endif?>
      
      <!-- Resources -->
      <Component Id="DirectOutputShapesPng" Directory="DOFDIR" Guid="*">
        <File Id="DirectOutputShapesPng" Source="bin\$(var.Platform)\Release\DirectOutputShapes.png" KeyPath="yes" />
      </Component>
      
      <Component Id="DirectOutputShapesXml" Directory="DOFDIR" Guid="*">
        <File Id="DirectOutputShapesXml" Source="bin\$(var.Platform)\Release\DirectOutputShapes.xml" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>